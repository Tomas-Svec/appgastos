<ion-header>
  <ion-toolbar class="expense-toolbar">
    <ion-title>Nuevo Gasto</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content class="ion-padding expense-content">
  <h2 class="modal-title">Registrar Gasto</h2>
  <p class="modal-subtitle">Ingresa los detalles de tu gasto</p>

  <!-- Error Message -->
  <div *ngIf="errorMessage" class="error-message">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <span>{{ errorMessage }}</span>
  </div>

  <form class="expense-form">
    <!-- Descripción del gasto -->
    <div class="form-group">
      <ion-item lines="none" class="ios-input">
        <ion-input
          [(ngModel)]="expense.description"
          name="description"
          type="text"
          placeholder="Descripción del gasto"
          [disabled]="isLoading">
        </ion-input>
      </ion-item>
    </div>

    <!-- Categoría y Monto -->
    <div class="form-row">
      <div class="form-group" style="flex: 1;">
        <div class="form-label-with-action">
          <ion-label class="form-label">Categoría</ion-label>
          <button type="button" class="add-category-link" (click)="toggleCategoryForm()">
            <ion-icon name="add-circle-outline"></ion-icon>
          </button>
        </div>
        <ion-item lines="none" class="ios-input">
          <ion-select
            [(ngModel)]="expense.category"
            name="category"
            placeholder="Selecciona"
            interface="popover"
            [disabled]="isLoading">
            <ion-select-option *ngFor="let cat of categories" [value]="cat.name">
              {{ cat.name }}
            </ion-select-option>
          </ion-select>
        </ion-item>
      </div>

      <div class="form-group" style="flex: 1;">
        <ion-label class="form-label">Monto</ion-label>
        <ion-item lines="none" class="ios-input">
          <ion-input
            [(ngModel)]="expense.amount"
            name="amount"
            type="number"
            placeholder="0.00"
            inputmode="decimal"
            (ionFocus)="onAmountFocus()"
            [disabled]="isLoading">
            <span slot="start">$</span>
          </ion-input>
        </ion-item>
      </div>
    </div>

    <!-- Mis Categorías -->
    <div class="categories-list">
      <p class="categories-title">Mis categorías</p>
      <div class="categories-grid">
        <div *ngFor="let cat of categories" class="category-badge">
          <span class="category-name">{{ cat.name }}</span>
          <button
            type="button"
            class="delete-category-btn"
            (click)="deleteCategory(cat.id, cat.name)"
            [disabled]="isLoading">
            <ion-icon name="close-circle"></ion-icon>
          </button>
        </div>
        <button type="button" class="add-new-category-btn" (click)="toggleCategoryForm()">
          Añadir Nueva
        </button>
      </div>

      <!-- Formulario de nueva categoría -->
      <div *ngIf="showCategoryForm" class="new-category-form">
        <div class="form-group">
          <ion-label class="form-label">Nombre de la categoría</ion-label>
          <ion-item lines="none" class="ios-input">
            <ion-input
              [(ngModel)]="newCategoryName"
              name="newCategoryName"
              type="text"
              placeholder="Ej: Mascotas"
              [disabled]="isLoading">
            </ion-input>
          </ion-item>
        </div>

        <div class="category-button-group">
          <ion-button
            expand="block"
            size="small"
            class="add-category-button"
            (click)="addCategory()"
            [disabled]="isLoading">
            <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
            <span *ngIf="!isLoading">Crear Categoría</span>
          </ion-button>
          <ion-button
            expand="block"
            size="small"
            fill="clear"
            (click)="toggleCategoryForm()">
            Cancelar
          </ion-button>
        </div>
      </div>
    </div>

    <!-- Toggle de cuotas -->
    <div class="form-group">
      <div class="toggle-row">
        <ion-label>¿Es compra en cuotas?</ion-label>
        <ion-toggle
          [(ngModel)]="expense.hasInstallments"
          name="hasInstallments"
          color="primary"
          [disabled]="isLoading">
        </ion-toggle>
      </div>
    </div>

    <!-- Campos de cuotas (solo si está activo) -->
    <div *ngIf="expense.hasInstallments" class="installments-section">
      <div class="form-row">
        <div class="form-group" style="flex: 1;">
          <ion-label class="form-label">Número de cuotas</ion-label>
          <ion-item lines="none" class="ios-input">
            <ion-input
              [(ngModel)]="expense.installments"
              name="installments"
              type="number"
              placeholder="Ej: 12"
              inputmode="numeric"
              (ionFocus)="onInstallmentsFocus()"
              [disabled]="isLoading">
            </ion-input>
          </ion-item>
        </div>

        <div class="form-group" style="flex: 1;">
          <ion-label class="form-label">Primer pago</ion-label>
          <ion-item lines="none" class="ios-input">
            <ion-input
              [(ngModel)]="expense.firstPaymentDate"
              name="firstPaymentDate"
              type="date"
              [disabled]="isLoading">
            </ion-input>
          </ion-item>
        </div>
      </div>
    </div>

    <!-- Botones -->
    <div class="button-group">
      <ion-button
        expand="block"
        class="ios-button-large save-button"
        (click)="saveExpense()"
        [disabled]="isLoading || !expense.description || !expense.amount || expense.amount <= 0">
        <ion-spinner *ngIf="isLoading" name="crescent"></ion-spinner>
        <span *ngIf="!isLoading">Guardar Gasto</span>
        <span *ngIf="isLoading">Guardando...</span>
      </ion-button>

      <ion-button
        expand="block"
        fill="clear"
        class="cancel-button"
        (click)="dismiss()"
        [disabled]="isLoading">
        Cancelar
      </ion-button>
    </div>
  </form>
</ion-content>
